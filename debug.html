<!DOCTYPE html>
<html>
<head>
    <title>D2Ræ‰©å±•è°ƒè¯•å·¥å…·</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #4a6fa5; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .log { background: #333; color: #0f0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .status { padding: 10px; margin: 5px 0; border-radius: 4px; }
        .status-success { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-warning { background: #fff3cd; color: #856404; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”§ D2Ræ‰©å±•è°ƒè¯•å·¥å…·</h1>
        
        <div class="card">
            <h2>1. æ‰©å±•çŠ¶æ€æ£€æŸ¥</h2>
            <button class="btn btn-primary" onclick="checkExtensionStatus()">æ£€æŸ¥æ‰©å±•çŠ¶æ€</button>
            <div id="extensionStatus" class="status">ç­‰å¾…æ£€æŸ¥...</div>
        </div>
        
        <div class="card">
            <h2>2. å­˜å‚¨æ•°æ®æ£€æŸ¥</h2>
            <button class="btn btn-primary" onclick="checkStorageData()">æ£€æŸ¥å­˜å‚¨æ•°æ®</button>
            <div id="storageData" class="log">ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹...</div>
        </div>
        
        <div class="card">
            <h2>3. ä»·æ ¼æ•°æ®æ“ä½œ</h2>
            <button class="btn btn-success" onclick="fetchPrices()">æ‰‹åŠ¨è·å–ä»·æ ¼</button>
            <button class="btn btn-primary" onclick="clearStorage()">æ¸…é™¤å­˜å‚¨æ•°æ®</button>
            <button class="btn btn-danger" onclick="resetExtension()">é‡ç½®æ‰©å±•</button>
            <div id="priceData" class="log">æ“ä½œç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
        
        <div class="card">
            <h2>4. æ¨¡æ‹Ÿä»·æ ¼æ•°æ®</h2>
            <button class="btn btn-primary" onclick="addMockData()">æ·»åŠ æ¨¡æ‹Ÿæ•°æ®</button>
            <div id="mockDataResult" class="status">ç­‰å¾…æ“ä½œ...</div>
        </div>
        
        <div class="card">
            <h2>5. å®æ—¶æ—¥å¿—</h2>
            <button class="btn btn-primary" onclick="startLogging()">å¼€å§‹æ—¥å¿—è®°å½•</button>
            <button class="btn btn-danger" onclick="stopLogging()">åœæ­¢æ—¥å¿—è®°å½•</button>
            <div id="liveLog" class="log">æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
        </div>
        
        <div class="card">
            <h2>6. å†…å®¹è„šæœ¬æµ‹è¯•</h2>
            <p>æ‰“å¼€ä»¥ä¸‹ç½‘ç«™æµ‹è¯•å†…å®¹è„šæœ¬ï¼š</p>
            <ul>
                <li><a href="https://www.g2g.com/cn/categories/diablo-2-resurrected-item-for-sale?fa=7075ff24%3Ac16696b1%7C7071deb3%3A4d2c8b55%7Cec59a3aa%3A9fa18172,53c0e8e3,28b7948c,d9ab9405,274a78dd,7c273a77,c41e297e,caa33535,b980ce6c,b3984b8d,e6414e3b&sort=lowest_price" target="_blank">G2Gæµ‹è¯•é¡µé¢</a></li>
                <li><a href="https://www.dd373.com/s-1psrbm-u6w1hm-hx35xs-0-0-0-sndbsb-0-0-0-0-0-1-20-0-1.html?qufu=true" target="_blank">DD373æµ‹è¯•é¡µé¢</a></li>
            </ul>
            <div id="contentScriptStatus" class="status">ç­‰å¾…æµ‹è¯•...</div>
        </div>
    </div>
    
    <script>
        let logInterval;
        
        // 1. æ£€æŸ¥æ‰©å±•çŠ¶æ€
        function checkExtensionStatus() {
            const statusEl = document.getElementById('extensionStatus');
            statusEl.innerHTML = 'æ£€æŸ¥ä¸­...';
            statusEl.className = 'status status-warning';
            
            try {
                // æ£€æŸ¥chrome API
                if (typeof chrome === 'undefined' || !chrome.runtime) {
                    statusEl.innerHTML = 'âŒ Chromeæ‰©å±•APIä¸å¯ç”¨ï¼ˆå¯èƒ½ä¸æ˜¯æ‰©å±•ç¯å¢ƒï¼‰';
                    statusEl.className = 'status status-error';
                    return;
                }
                
                // è·å–æ‰©å±•ä¿¡æ¯
                const manifest = chrome.runtime.getManifest();
                
                let html = `<div class="status-success">âœ… æ‰©å±•çŠ¶æ€æ­£å¸¸</div>`;
                html += `<div><strong>åç§°:</strong> ${manifest.name}</div>`;
                html += `<div><strong>ç‰ˆæœ¬:</strong> ${manifest.version}</div>`;
                html += `<div><strong>æè¿°:</strong> ${manifest.description}</div>`;
                html += `<div><strong>æƒé™:</strong> ${JSON.stringify(manifest.permissions)}</div>`;
                
                statusEl.innerHTML = html;
                statusEl.className = 'status status-success';
                
            } catch (error) {
                statusEl.innerHTML = `âŒ é”™è¯¯: ${error.message}`;
                statusEl.className = 'status status-error';
            }
        }
        
        // 2. æ£€æŸ¥å­˜å‚¨æ•°æ®
        function checkStorageData() {
            const dataEl = document.getElementById('storageData');
            dataEl.innerHTML = 'è¯»å–ä¸­...';
            
            chrome.storage.local.get(null, (result) => {
                let html = '<strong>æ‰€æœ‰å­˜å‚¨æ•°æ®:</strong><br>';
                
                if (Object.keys(result).length === 0) {
                    html += 'âš ï¸ å­˜å‚¨ä¸ºç©º';
                } else {
                    for (const [key, value] of Object.entries(result)) {
                        html += `<br><strong>${key}:</strong><br>`;
                        html += `<pre>${JSON.stringify(value, null, 2)}</pre>`;
                    }
                }
                
                dataEl.innerHTML = html;
            });
        }
        
        // 3. æ‰‹åŠ¨è·å–ä»·æ ¼
        function fetchPrices() {
            const dataEl = document.getElementById('priceData');
            dataEl.innerHTML = 'è¯·æ±‚ä¸­...';
            
            chrome.runtime.sendMessage({ action: 'fetchPrices' }, (response) => {
                if (response && response.success) {
                    dataEl.innerHTML = `<div class="status-success">âœ… ä»·æ ¼è·å–æˆåŠŸ</div><pre>${JSON.stringify(response.prices, null, 2)}</pre>`;
                } else {
                    dataEl.innerHTML = `<div class="status-error">âŒ ä»·æ ¼è·å–å¤±è´¥: ${response?.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                }
            });
        }
        
        // æ¸…é™¤å­˜å‚¨æ•°æ®
        function clearStorage() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å­˜å‚¨æ•°æ®å—ï¼Ÿ')) {
                chrome.storage.local.clear(() => {
                    document.getElementById('priceData').innerHTML = '<div class="status-success">âœ… å­˜å‚¨æ•°æ®å·²æ¸…é™¤</div>';
                    checkStorageData();
                });
            }
        }
        
        // é‡ç½®æ‰©å±•
        function resetExtension() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰©å±•å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰æ•°æ®å¹¶é‡æ–°åŠ è½½æ‰©å±•ã€‚')) {
                chrome.storage.local.clear(() => {
                    chrome.runtime.reload();
                    document.getElementById('priceData').innerHTML = '<div class="status-success">âœ… æ‰©å±•å·²é‡ç½®ï¼Œæ­£åœ¨é‡æ–°åŠ è½½...</div>';
                });
            }
        }
        
        // 4. æ·»åŠ æ¨¡æ‹Ÿæ•°æ®
        function addMockData() {
            const resultEl = document.getElementById('mockDataResult');
            resultEl.innerHTML = 'æ·»åŠ ä¸­...';
            resultEl.className = 'status status-warning';
            
            const mockPrices = {
                '30#': {
                    rune: '30#',
                    name: 'Ber',
                    g2gPrice: 850.75,
                    dd373Price: 720.30,
                    lastUpdated: new Date().toISOString()
                },
                '31#': {
                    rune: '31#',
                    name: 'Jah',
                    g2gPrice: 950.50,
                    dd373Price: 850.50,
                    lastUpdated: new Date().toISOString()
                },
                '32#': {
                    rune: '32#',
                    name: 'Cham',
                    g2gPrice: 1200.00,
                    dd373Price: 1100.00,
                    lastUpdated: new Date().toISOString()
                }
            };
            
            chrome.storage.local.set({ d2rPrices: mockPrices }, () => {
                resultEl.innerHTML = '<div class="status-success">âœ… æ¨¡æ‹Ÿæ•°æ®æ·»åŠ æˆåŠŸï¼</div>';
                resultEl.className = 'status status-success';
                checkStorageData();
                
                // é€šçŸ¥popupæ›´æ–°
                chrome.runtime.sendMessage({
                    action: 'pricesUpdated',
                    prices: mockPrices
                });
            });
        }
        
        // 5. å®æ—¶æ—¥å¿—
        function startLogging() {
            const logEl = document.getElementById('liveLog');
            logEl.innerHTML = 'å¼€å§‹è®°å½•æ—¥å¿—...\n';
            
            // ç›‘å¬æ¥è‡ªå†…å®¹è„šæœ¬çš„æ¶ˆæ¯
            chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
                if (message.action === 'debug' || message.action === 'pagePrices') {
                    const time = new Date().toLocaleTimeString();
                    logEl.innerHTML += `[${time}] ${message.action}: ${JSON.stringify(message.data || message.prices || {})}\n`;
                    logEl.scrollTop = logEl.scrollHeight;
                }
                sendResponse({ received: true });
                return true;
            });
            
            logInterval = setInterval(() => {
                const time = new Date().toLocaleTimeString();
                logEl.innerHTML += `[${time}] å¿ƒè·³...\n`;
                logEl.scrollTop = logEl.scrollHeight;
            }, 5000);
        }
        
        function stopLogging() {
            if (logInterval) {
                clearInterval(logInterval);
                const logEl = document.getElementById('liveLog');
                logEl.innerHTML += 'æ—¥å¿—è®°å½•å·²åœæ­¢\n';
            }
        }
        
        // 6. å†…å®¹è„šæœ¬æµ‹è¯•
        function testContentScript() {
            const statusEl = document.getElementById('contentScriptStatus');
            statusEl.innerHTML = 'æµ‹è¯•ä¸­...';
            
            // æ¨¡æ‹Ÿå‘é€æ¶ˆæ¯åˆ°å†…å®¹è„šæœ¬
            chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
                if (tabs[0]) {
                    chrome.tabs.sendMessage(tabs[0].id, { action: 'test' }, (response) => {
                        if (chrome.runtime.lastError) {
                            statusEl.innerHTML = `âŒ å†…å®¹è„šæœ¬æœªå“åº”: ${chrome.runtime.lastError.message}`;
                            statusEl.className = 'status status-error';
                        } else {
                            statusEl.innerHTML = 'âœ… å†…å®¹è„šæœ¬å“åº”æ­£å¸¸';
                            statusEl.className = 'status status-success';
                        }
                    });
                }
            });
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            checkExtensionStatus();
            checkStorageData();
        };
    </script>
</body>
</html>